<html lang="pt-br">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>TCC - Kássia Machado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.1/mdb.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-4"></div>

            <div class="col-md-4 mt-2">
                <div class="titulo">
                    <p>CALCULADORA<br>SPRINT</p>
                </div>
            </div>

            <div class="col-md-4"></div>
        </div>
        <div class="row mt-5">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Caminho Critico</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text display-6" id="caminhoCritico">A CALCULAR</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Prazo Total</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text display-6" id="prazoMaximo">A CALCULAR</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Adicionar Tarefa</h5>
                    </div>
                    <div class="card-body">
                        <form id="formTarefa">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group mb-3">
                                        <div class="form-outline">
                                            <input type="text" id="nomeTarefa" class="form-control form-control-lg"
                                                required />
                                            <label class="form-label" for="nomeTarefa">Tarefa</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group mb-3">
                                        <div class="form-outline">
                                            <input type="number" id="tempoTarefa" min="0"
                                                class="form-control form-control-lg" required />
                                            <label class="form-label" for="tempoTarefa">Tempo de Entrega (dias)</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="input-group mb-3">
                                        <div class="form-outline">
                                            <input type="text" id="tarefasDependentes"
                                                class="form-control form-control-lg" />
                                            <label class="form-label" for="tarefasDependentes">Dependentes</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="submit" class="btn btn-primary btn-lg btn-floating"
                                        style="background-color: #1f95cb;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Tarefas</h5>
                    </div>
                    <div class="card-body">
                        <table class="table align-middle mb-0 bg-white" id="tabelaTarefas">
                            <thead class="bg-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Descrição Tarefa</th>
                                    <th>Tempo de Entrega</th>
                                    <th>Tarefa Dependente</th>
                                    <th>Resultado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MDB -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.1/mdb.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        html,
        body {
            background: #00e9d3;
        }
        .titulo {
            margin-top: 25px;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            background: #ffffff;
            color: #1f95cb;
            border-radius: 20px;
        }
        .titulo p {
            margin-bottom: 0;
            font-size: 1.6em;
        }
    </style>
    <script>
        var codigo = 0;
        var table;
        $(document).ready(function () {
            table = $('#tabelaTarefas').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.1/i18n/pt-BR.json'
                }
            });

            $('#tabelaTarefas tbody').on('click', 'button', function () {
                var conteudoLinha = table.row($(this).parents('tr')).data();
                var codigoTarefa = conteudoLinha[0];
                var isDependente = VerificarDependentes(codigoTarefa);

                if (isDependente) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Oops...',
                        text: "Não é possível excluir uma tarefa que possui dependentes."
                    });
                } else {
                    table.row($(this).parents('tr')).remove().draw();
                    EnviarParaApi();
                }
            });
        });

        function CadastrarTarefa() {

            var novoCodigoTarefa = codigo + 1;

            //verificar se existe as tarefas se tiver dependentes
            if ($("#tarefasDependentes").val() != "") {
                var isTemTodosDependentes = VerificarSeExisteTarefasDependentes($("#tarefasDependentes").val().split(","));
                if (!isTemTodosDependentes) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Oops...',
                        text: "Não é possível cadastrar a tarefa, pois não existe tarefa dependente correspondente a informada."
                    });
                    return;
                }
            }

            codigo = novoCodigoTarefa;
            table.row.add([
                codigo,
                $("#nomeTarefa").val(),
                $("#tempoTarefa").val(),
                $("#tarefasDependentes").val(),
                "",
                "<button type=\"button\" class=\"btn btn-danger btn-floating\"><i class=\"fas fa-trash\"></i></button>"
            ]).draw();
            EnviarParaApi();
            $("#formTarefa").trigger("reset");
        }

        function VerificarDependentes(codigoTarefa) {
            var linhasTabela = table.rows().data();

            var resultado = false;

            $.each(linhasTabela, function (numeroLinha, conteudoLinha) {
                var arrTarefasDependentes = conteudoLinha[3].split(",");

                $.each(arrTarefasDependentes, function (indexDependente, identificadorTarefaDependente) {
                    if (parseInt(identificadorTarefaDependente) == parseInt(codigoTarefa)) {
                        resultado = true;
                    }
                });

            });

            return resultado;
        }

        function VerificarSeExisteTarefasDependentes(arrDependentes) {
            var linhasTabela = table.rows().data();

            var resultado = false;

            $.each(arrDependentes, function (nDependente, rDependente) {
                resultado = false;

                $.each(linhasTabela, function (nTabela, rTabela) {
                    if (parseInt(rTabela[0]) == parseInt(rDependente)) {
                        resultado = true;
                    }
                });

                if (resultado == false) {
                    return false;
                }
            });

            return resultado;
        }

        function CriarObjetoJson() {
            var arrObj = [];
            var linhasTabela = table.rows().data();
            $.each(linhasTabela, function (nTabela, rTabela) {
                var obj = {
                    codigo: parseInt(rTabela[0]),
                    descricao: rTabela[1],
                    tempoEntrega: parseInt(rTabela[2]),
                    tarefasDependentes: []
                };

                if (rTabela[3] != '') {
                    var tarefasDependentes = rTabela[3].split(",");
                    $.each(tarefasDependentes, function (tIndex, tContent) {
                        obj.tarefasDependentes.push(parseInt(tContent));
                    });
                }

                arrObj.push(obj);
            });

            return JSON.stringify(arrObj);
        }

        function EnviarParaApi() {
            if (linhasTabela = table.rows().data().length > 0) {
                var obj = CriarObjetoJson();

                $.ajax({
                    url: "https://localhost:7282/calcular_tarefas",
                    method: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    data: obj
                }).done(function (r) {
                    $("#prazoMaximo").html(r.prazoMaximo + " dia(s)");
                    $("#caminhoCritico").html(r.caminhoCritico);
                    AtualizarLinhaComResultado(r.pontuacoes);
                }).fail(function (xhr, err, stack) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Algo deu errado ao enviar o calculo para a API!' + xhr.responseText
                    });
                });
            } else {
                $("#prazoMaximo").html("A CALCULAR");
                $("#caminhoCritico").html("A CALCULAR");
            }
        }

        function AtualizarLinhaComResultado(pontuacoes) {
            $.each(pontuacoes, function (pIndex, pContent) {
                $.each(table.rows().data(), function (tIndex, tContent) {
                    if (tContent[0] == pContent.codigoTarefa) {
                        var resultado = "Ida Início: " + pContent.idaInicio + " dias<br>Ida Fim: " + pContent.idaFim + " dias<br>Volta Início: " + pContent.voltaInicio + " dias<br>Volta Fim: " + pContent.voltaFim + " dias";
                        tContent[4] = resultado;
                        table.row(tIndex).data(tContent).draw();
                    }
                });
            });
        }

        $("#formTarefa").submit(function (e) {
            e.preventDefault();
            CadastrarTarefa();
            $("#nomeTarefa").focus();
        });
    </script>
</body>

</html>